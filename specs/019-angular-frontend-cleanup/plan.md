# Implementation Plan: Angular Frontend Performance & Quality Cleanup

**Branch**: `019-angular-frontend-cleanup` | **Date**: 2025-12-30 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/019-angular-frontend-cleanup/spec.md`

## Summary

Refactoring technique du frontend Angular pour éliminer les fuites mémoire, optimiser la détection de changements, et standardiser les patterns de gestion des abonnements RxJS. L'objectif est d'assurer une stabilité mémoire (<20% variation) après 4 heures d'utilisation et une réactivité UI <200ms.

## Technical Context

**Language/Version**: TypeScript 5.9.3 with Angular 21.0.6
**Primary Dependencies**: Angular 21, NgRx 21.x, RxJS 7.8.2, Angular Material 21.0.5, Leaflet 1.9.4
**Storage**: N/A (frontend refactoring, backend inchangé)
**Testing**: Jasmine/Karma (unit), Lighthouse (performance), Chrome DevTools (memory profiling)
**Target Platform**: Web browsers - Chrome, Firefox, Safari, Edge (latest 2 versions)
**Project Type**: Web application (frontend only)
**Performance Goals**: 60 FPS rendering, <200ms filter response, <500KB initial bundle, <20% memory variation
**Constraints**: OnPush mandatory, takeUntilDestroyed() for all subscriptions, signals for reactive state
**Scale/Scope**: 7 composants à corriger, ~15 fichiers impactés

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| III. Code Quality & Testing | PASS | Refactoring améliore la qualité, tests existants maintenus |
| IV. Performance Requirements | PASS | Feature vise directement les benchmarks (LCP <1.5s, 60 FPS) |
| VI. User Experience Consistency | PASS | Aucun changement UX, amélioration des temps de réponse |

**Gate Result**: PASS - Aucune violation de la constitution.

## Project Structure

### Documentation (this feature)

```text
specs/019-angular-frontend-cleanup/
├── plan.md              # This file
├── research.md          # Best practices Angular memory management
├── quickstart.md        # How to test/validate the cleanup
├── checklists/
│   └── requirements.md  # Spec validation checklist
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
frontend/
├── src/
│   ├── app/
│   │   ├── admin/
│   │   │   ├── trips/
│   │   │   │   └── trip-list/
│   │   │   │       └── trip-list.component.ts    # P1 - Memory leak fix
│   │   │   ├── users/
│   │   │   │   ├── user-list/
│   │   │   │   │   └── user-list.component.ts    # P1 - Memory leak fix
│   │   │   │   └── user-form/
│   │   │   │       └── user-form.component.ts    # P2 - OnPush optimization
│   │   │   ├── trucks/
│   │   │   │   └── truck-list/
│   │   │   │       └── truck-list.component.ts   # P1 - Memory leak fix
│   │   │   ├── groups/
│   │   │   │   ├── group-list/
│   │   │   │   │   └── group-list.component.ts   # P1 - Memory leak fix
│   │   │   │   └── group-form/
│   │   │   │       └── group-form.component.ts   # P2 - OnPush optimization
│   │   │   ├── audit/
│   │   │   │   └── audit-log/
│   │   │   │       └── audit-log.component.ts    # P1 - Memory leak fix
│   │   │   └── shared/
│   │   │       ├── data-table/
│   │   │       │   └── data-table.component.ts   # P2 - OnPush optimization
│   │   │       └── location-picker/
│   │   │           └── location-picker.component.ts # P1 - Map cleanup
│   │   └── store/
│   │       └── (existing - well implemented)
│   └── ANGULAR_CONVENTIONS.md                    # Update with new patterns
└── tests/
    └── performance/                              # New: Lighthouse CI config
```

**Structure Decision**: Modification de fichiers existants uniquement. Aucun nouveau module ou service requis. Le store NgRx existant est déjà bien implémenté avec des selectors memoized.

## Implementation Strategy

### Phase 1: Memory Leak Fixes (P1 - Critical)

**Pattern Standard**: Utiliser `takeUntilDestroyed()` de `@angular/core/rxjs-interop`

```typescript
// AVANT (problème)
ngOnInit() {
  this.service.getData().subscribe(data => this.data = data);
}

// APRÈS (solution)
private destroyRef = inject(DestroyRef);

ngOnInit() {
  this.service.getData()
    .pipe(takeUntilDestroyed(this.destroyRef))
    .subscribe(data => this.data = data);
}
```

**Composants prioritaires**:
1. `TripListComponent` - interval() + subscriptions multiples
2. `UserListComponent` - 4+ subscriptions sans cleanup
3. `TruckListComponent` - subscriptions sans cleanup
4. `GroupListComponent` - subscriptions sans cleanup
5. `LocationPickerComponent` - map listeners non nettoyés
6. `AuditLogComponent` - subscriptions sans cleanup

### Phase 2: OnPush Optimization (P2)

**Pattern Standard**:

```typescript
@Component({
  changeDetection: ChangeDetectionStrategy.OnPush,
  // ...
})
export class MyComponent {
  // Utiliser signals ou async pipe pour les données réactives
  readonly data = this.facade.someData;  // Signal from store
}
```

**Composants à optimiser**:
1. `TripListComponent`
2. `UserListComponent`
3. `UserFormComponent`
4. `DataTableComponent`
5. `TruckFormComponent`
6. `GroupFormComponent`

### Phase 3: Documentation & Validation (P3)

1. Mettre à jour `ANGULAR_CONVENTIONS.md` avec les patterns obligatoires
2. Configurer Lighthouse CI dans le pipeline
3. Documenter les métriques de performance baseline vs post-cleanup

## Dependencies Between Tasks

```text
[Memory Leak Fixes] ──────────────────────────────────────┐
    │                                                     │
    ├── TripListComponent ───┐                           │
    ├── UserListComponent ───┼── Can run in parallel     │
    ├── TruckListComponent ──┤                           │
    ├── GroupListComponent ──┤                           │
    ├── LocationPickerComponent ─┘                       │
    └── AuditLogComponent ───────┘                       │
                                                         ▼
[OnPush Optimization] ───────────────────────────────────┤
    │                                                     │
    ├── TripListComponent ───┐                           │
    ├── UserListComponent ───┼── Can run in parallel     │
    ├── UserFormComponent ───┤   (after memory fixes)    │
    ├── DataTableComponent ──┤                           │
    ├── TruckFormComponent ──┤                           │
    └── GroupFormComponent ──┘                           │
                                                         ▼
[Documentation & Validation] ────────────────────────────┘
    │
    ├── Update ANGULAR_CONVENTIONS.md
    ├── Configure Lighthouse CI
    └── Performance regression tests
```

## Testing Strategy

### Memory Testing (Manual + Automated)

1. **Chrome DevTools Memory Tab**:
   - Take heap snapshot before navigation
   - Navigate through all admin pages 10 times
   - Take heap snapshot after
   - Compare: detached DOM nodes should be 0, memory delta < 20%

2. **Performance Timeline**:
   - Record 5 minutes of typical usage
   - Check for growing memory trend (should be flat)

### Performance Testing (Lighthouse CI)

```yaml
# lighthouse-ci.yaml (à ajouter au CI)
assertions:
  first-contentful-paint: ["error", {"maxNumericValue": 1500}]
  largest-contentful-paint: ["error", {"maxNumericValue": 2500}]
  cumulative-layout-shift: ["error", {"maxNumericValue": 0.1}]
  total-blocking-time: ["error", {"maxNumericValue": 200}]
```

### Regression Testing

- Tous les tests unitaires existants doivent passer
- Tests E2E Cypress existants doivent passer
- Nouveau: test de non-régression mémoire dans CI

## Complexity Tracking

> Aucune violation de la constitution - section non applicable.

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Régression fonctionnelle | Exécuter tests avant/après chaque composant |
| OnPush casse le rendering | Vérifier que toutes les données sont des signals ou observables |
| Manque de couverture de test | Ajouter tests si couverture < 70% sur composant modifié |

## Estimated Effort

| Phase | Composants | Effort Estimé |
|-------|------------|---------------|
| Phase 1: Memory Leaks | 6 composants | ~2-3h par composant |
| Phase 2: OnPush | 6 composants | ~1-2h par composant |
| Phase 3: Documentation | N/A | ~2-4h total |
| **Total** | | ~20-30h |

## Success Validation

Avant merge, vérifier:

- [ ] `npm run build` - Build réussi sans warnings
- [ ] `npm run test` - Tous les tests passent
- [ ] Memory profiling - Pas de fuite détectée après 1h de navigation
- [ ] Lighthouse score Performance > 80
- [ ] Bundle size < 500KB gzippé
