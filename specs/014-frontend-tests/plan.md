# Implementation Plan: Frontend Unit Tests

**Branch**: `014-frontend-tests` | **Date**: 2025-12-27 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/014-frontend-tests/spec.md`

## Summary

Implémentation de tests unitaires performants pour le frontend Angular TruckTrack, en privilégiant l'instanciation directe des classes (sans TestBed) pour les guards, services simples, et en réservant TestBed uniquement pour les intercepteurs et cas nécessitant le DI Angular.

## Technical Context

**Language/Version**: TypeScript 5.4 avec Angular 17
**Primary Dependencies**: Jasmine, Karma, Angular Testing Utilities
**Storage**: N/A (tests uniquement)
**Testing**: Jasmine/Karma (déjà configuré dans le projet)
**Target Platform**: Navigateurs web (Chrome headless pour CI)
**Project Type**: Frontend Angular (monorepo avec backend)
**Performance Goals**: Exécution totale < 30 secondes, < 2s par fichier
**Constraints**: Éviter TestBed sauf nécessité absolue, pas de tests triviaux
**Scale/Scope**: ~15-20 fichiers de tests couvrant services, guards, interceptors

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| III. Code Quality & Testing Standards | ✅ PASS | Tests suivent les standards (80% coverage cible, TDD) |
| III. Test Coverage | ✅ PASS | 70% frontend minimum requis, cette feature y contribue |
| IV. Performance Requirements | ✅ PASS | Tests rapides (< 30s total) supportent CI rapide |
| VI. UX Consistency | ⚪ N/A | Feature de tests, pas d'impact UX direct |

**Gate Status**: ✅ PASS - Aucune violation constitutionnelle

## Project Structure

### Documentation (this feature)

```text
specs/014-frontend-tests/
├── plan.md              # This file
├── research.md          # Patterns de tests sans TestBed
├── quickstart.md        # Exemples de tests
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (tests)

```text
frontend/src/app/
├── core/
│   ├── services/
│   │   ├── auth.service.ts
│   │   ├── auth.service.spec.ts          # NEW
│   │   ├── permission.service.ts
│   │   ├── permission.service.spec.ts    # NEW
│   │   ├── token-storage.service.ts
│   │   ├── token-storage.service.spec.ts # NEW
│   │   ├── navigation.service.ts
│   │   └── navigation.service.spec.ts    # NEW
│   ├── guards/
│   │   ├── auth.guard.ts
│   │   ├── auth.guard.spec.ts            # NEW
│   │   ├── admin.guard.ts
│   │   ├── admin.guard.spec.ts           # NEW
│   │   ├── page.guard.ts
│   │   └── page.guard.spec.ts            # NEW
│   └── interceptors/
│       ├── auth.interceptor.ts
│       └── auth.interceptor.spec.ts      # NEW (TestBed required)
├── services/
│   ├── truck.service.ts
│   ├── truck.service.spec.ts             # NEW
│   ├── geofence.service.ts
│   ├── geofence.service.spec.ts          # NEW
│   ├── notification.service.ts
│   ├── notification.service.spec.ts      # NEW
│   └── alert-rule.service.ts
└── features/
    └── analytics/services/
        ├── analytics.service.ts
        └── analytics.service.spec.ts     # NEW
```

**Structure Decision**: Tests colocalisés avec les fichiers source (pattern Angular standard)

## Testing Approach

### Sans TestBed (Performance optimale)

**Guards** - Instanciation directe avec mocks:
```typescript
// auth.guard.spec.ts
describe('AuthGuard', () => {
  let guard: AuthGuard;
  let mockAuthService: jasmine.SpyObj<AuthService>;
  let mockRouter: jasmine.SpyObj<Router>;

  beforeEach(() => {
    mockAuthService = jasmine.createSpyObj('AuthService', ['isAuthenticated']);
    mockRouter = jasmine.createSpyObj('Router', ['createUrlTree']);
    guard = new AuthGuard(mockAuthService, mockRouter);
  });
});
```

**Services simples** - Instanciation directe:
```typescript
// token-storage.service.spec.ts
describe('TokenStorageService', () => {
  let service: TokenStorageService;

  beforeEach(() => {
    localStorage.clear();
    service = new TokenStorageService();
  });
});
```

### Avec TestBed (Quand nécessaire)

**Interceptors** - Nécessite HttpClientTestingModule:
```typescript
// auth.interceptor.spec.ts
describe('AuthInterceptor', () => {
  beforeEach(() => {
    TestBed.configureTestingModule({
      imports: [HttpClientTestingModule],
      providers: [AuthInterceptor, TokenStorageService]
    });
  });
});
```

**Services avec HttpClient** - HttpClientTestingModule pour mocker les appels:
```typescript
// truck.service.spec.ts
describe('TruckService', () => {
  beforeEach(() => {
    TestBed.configureTestingModule({
      imports: [HttpClientTestingModule],
      providers: [TruckService]
    });
  });
});
```

## Files to Create

| File | TestBed | Priority | Tests estimés |
|------|---------|----------|---------------|
| auth.service.spec.ts | Oui (HttpClient) | P1 | 8-10 |
| permission.service.spec.ts | Non | P1 | 6-8 |
| token-storage.service.spec.ts | Non | P1 | 5-6 |
| auth.guard.spec.ts | Non | P1 | 4-5 |
| admin.guard.spec.ts | Non | P1 | 3-4 |
| page.guard.spec.ts | Non | P1 | 4-5 |
| auth.interceptor.spec.ts | Oui (HttpTestingController) | P2 | 5-6 |
| navigation.service.spec.ts | Non | P3 | 4-5 |
| truck.service.spec.ts | Oui (HttpClient) | P2 | 6-8 |
| geofence.service.spec.ts | Oui (HttpClient) | P2 | 5-6 |
| notification.service.spec.ts | Oui (HttpClient) | P2 | 5-6 |

**Total estimé**: ~60-70 tests

## Complexity Tracking

> Aucune violation constitutionnelle - section vide

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| - | - | - |
