name: CI

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  # Detect which parts of the codebase changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      mobile: ${{ steps.filter.outputs.mobile }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'pom.xml'
            frontend:
              - 'frontend/**'
            mobile:
              - 'mobile-expo/**'

  # Build shared module once (avoid rebuilding N times in matrix)
  backend-build:
    name: Backend Build
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: 'maven'

      - name: Build shared module
        working-directory: backend
        run: mvn install -pl shared -am -DskipTests -T 1C

      - name: Cache built shared module
        uses: actions/cache/save@v4
        with:
          path: ~/.m2/repository/com/trucktrack/shared
          key: shared-module-${{ github.sha }}

  # Backend tests (matrix for all microservices)
  backend:
    name: Backend - ${{ matrix.service }}
    needs: [changes, backend-build]
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      fail-fast: false
      matrix:
        service:
          - api-gateway
          - auth-service
          - gps-ingestion-service
          - location-service
          - notification-service
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: 'maven'

      - name: Restore shared module from cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.m2/repository/com/trucktrack/shared
          key: shared-module-${{ github.sha }}

      - name: Test ${{ matrix.service }}
        working-directory: backend/${{ matrix.service }}
        run: mvn test -B -T 1C
        env:
          SPRING_DATASOURCE_DRIVER: org.postgresql.Driver
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
          SPRING_DATASOURCE_USERNAME: testuser
          SPRING_DATASOURCE_PASSWORD: testpass

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.service }}
          path: backend/${{ matrix.service }}/target/site/jacoco/
          retention-days: 7

      - name: Upload compiled classes
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: classes-${{ matrix.service }}
          path: backend/${{ matrix.service }}/target/classes/
          retention-days: 1

  # Frontend tests
  frontend:
    name: Frontend
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci --legacy-peer-deps

      - name: Lint
        working-directory: frontend
        run: npm run lint || true

      - name: Test
        working-directory: frontend
        run: npm test -- --no-watch --no-progress --browsers=ChromeHeadless --code-coverage

      - name: Check coverage thresholds
        working-directory: frontend
        run: |
          echo "## Frontend Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract coverage from lcov report
          STATEMENTS=$(grep -m1 'Statements' coverage/frontend/index.html | grep -oP '\d+\.\d+(?=%)' || echo "0")
          LINES=$(grep -m1 'Lines' coverage/frontend/index.html | grep -oP '\d+\.\d+(?=%)' || echo "0")

          echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Statements | ${STATEMENTS}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines | ${LINES}% |" >> $GITHUB_STEP_SUMMARY

          # Check critical services coverage (guards, interceptors, core services)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Critical Services Coverage" >> $GITHUB_STEP_SUMMARY

          if [ -f "coverage/frontend/app/core/guards/index.html" ]; then
            GUARDS=$(grep -m1 'Statements' coverage/frontend/app/core/guards/index.html | grep -oP '\d+(?=%)' || echo "0")
            echo "- Guards: ${GUARDS}%" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "coverage/frontend/app/core/interceptors/index.html" ]; then
            INTERCEPTORS=$(grep -m1 'Statements' coverage/frontend/app/core/interceptors/index.html | grep -oP '\d+(?=%)' || echo "0")
            echo "- Interceptors: ${INTERCEPTORS}%" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "coverage/frontend/app/core/services/index.html" ]; then
            SERVICES=$(grep -m1 'Statements' coverage/frontend/app/core/services/index.html | grep -oP '\d+(?=%)' || echo "0")
            echo "- Core Services: ${SERVICES}%" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/
          retention-days: 7

  # Mobile tests
  mobile:
    name: Mobile
    needs: changes
    if: needs.changes.outputs.mobile == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile-expo/package-lock.json

      - name: Install dependencies
        working-directory: mobile-expo
        run: npm ci

      - name: Lint
        working-directory: mobile-expo
        run: npm run lint || true

      - name: Test
        working-directory: mobile-expo
        run: npm test -- --coverage --passWithNoTests

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-coverage
          path: mobile-expo/coverage/
          retention-days: 7

  # SonarCloud Analysis - Backend (runs in parallel with frontend)
  sonarcloud-backend:
    name: SonarCloud Backend
    needs: [changes, backend]
    if: |
      always() &&
      needs.changes.outputs.backend == 'true' &&
      needs.backend.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 50  # Shallow clone - sufficient for most PRs

      - name: Fetch base branch for blame
        run: |
          git fetch --depth=50 origin ${{ github.base_ref || 'master' }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: 'maven'

      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: backend-coverage/
          merge-multiple: true

      - name: Download compiled classes
        uses: actions/download-artifact@v4
        with:
          pattern: classes-*
          path: backend-classes/
          merge-multiple: true

      - name: Restore compiled classes to target directories
        run: |
          for service in api-gateway auth-service gps-ingestion-service location-service notification-service; do
            if [ -d "backend-classes/" ]; then
              mkdir -p backend/$service/target/classes
              cp -r backend-classes/* backend/$service/target/classes/ 2>/dev/null || true
            fi
          done

      - name: Build shared module only
        working-directory: backend
        run: mvn install -pl shared -am -DskipTests -q -T 1C

      - name: Restore coverage reports
        run: |
          for service in api-gateway auth-service gps-ingestion-service location-service notification-service; do
            if [ -d "backend-coverage/" ]; then
              mkdir -p backend/$service/target/site/jacoco
              cp -r backend-coverage/* backend/$service/target/site/jacoco/ 2>/dev/null || true
            fi
          done

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-backend
          restore-keys: ${{ runner.os }}-sonar-backend

      - name: SonarCloud Backend Scan
        working-directory: backend
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=salimomrani_trucktrack-backend \
            -Dsonar.organization=salimomrani \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.java.binaries=**/target/classes \
            -Dsonar.coverage.jacoco.xmlReportPaths=**/target/site/jacoco/jacoco.xml \
            -Dsonar.exclusions="**/generated/**,**/target/**,**/*Application.java,**/*Config*.java,**/migrations/**" \
            -Dsonar.cpd.exclusions="**/model/**,**/dto/**,**/entity/**" \
            -DskipTests -q -T 1C
        continue-on-error: true

  # SonarCloud Analysis - Frontend (runs in parallel with backend)
  sonarcloud-frontend:
    name: SonarCloud Frontend
    needs: [changes, frontend]
    if: |
      always() &&
      needs.changes.outputs.frontend == 'true' &&
      needs.frontend.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 50  # Shallow clone

      - name: Fetch base branch for blame
        run: |
          git fetch --depth=50 origin ${{ github.base_ref || 'master' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-frontend
          restore-keys: ${{ runner.os }}-sonar-frontend

      - name: SonarCloud Frontend Scan
        uses: SonarSource/sonarcloud-github-action@master
        with:
          projectBaseDir: frontend
          args: >
            -Dsonar.projectKey=salimomrani_trucktrack-frontend
            -Dsonar.organization=salimomrani
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.spec.ts
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/coverage/**,**/*.spec.ts,**/environments/**
            -Dsonar.typescript.lcov.reportPaths=coverage/frontend/lcov.info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  # Summary job
  summary:
    name: Summary
    needs: [changes, backend-build, backend, frontend, mobile, sonarcloud-backend, sonarcloud-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.changes.outputs.backend }}" == "true" ]; then
            if [ "${{ needs.backend.result }}" == "success" ]; then
              echo "| Backend | ✓ | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Backend | ✓ | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Backend | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.changes.outputs.frontend }}" == "true" ]; then
            if [ "${{ needs.frontend.result }}" == "success" ]; then
              echo "| Frontend | ✓ | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Frontend | ✓ | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Frontend | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.changes.outputs.mobile }}" == "true" ]; then
            if [ "${{ needs.mobile.result }}" == "success" ]; then
              echo "| Mobile | ✓ | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Mobile | ✓ | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Mobile | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
          fi

          # SonarCloud Backend result
          if [ "${{ needs.changes.outputs.backend }}" == "true" ]; then
            if [ "${{ needs.sonarcloud-backend.result }}" == "success" ]; then
              echo "| SonarCloud Backend | ✓ | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.sonarcloud-backend.result }}" == "skipped" ]; then
              echo "| SonarCloud Backend | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| SonarCloud Backend | ✓ | ⚠️ Warning |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| SonarCloud Backend | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
          fi

          # SonarCloud Frontend result
          if [ "${{ needs.changes.outputs.frontend }}" == "true" ]; then
            if [ "${{ needs.sonarcloud-frontend.result }}" == "success" ]; then
              echo "| SonarCloud Frontend | ✓ | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.sonarcloud-frontend.result }}" == "skipped" ]; then
              echo "| SonarCloud Frontend | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| SonarCloud Frontend | ✓ | ⚠️ Warning |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| SonarCloud Frontend | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any test failed
        if: |
          (needs.changes.outputs.backend == 'true' && needs.backend.result != 'success') ||
          (needs.changes.outputs.frontend == 'true' && needs.frontend.result != 'success') ||
          (needs.changes.outputs.mobile == 'true' && needs.mobile.result != 'success')
        run: exit 1
