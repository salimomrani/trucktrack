name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  # Detect which parts of the codebase changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      mobile: ${{ steps.filter.outputs.mobile }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'pom.xml'
            frontend:
              - 'frontend/**'
            mobile:
              - 'mobile-expo/**'

  # Backend tests (matrix for all microservices)
  backend:
    name: Backend - ${{ matrix.service }}
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      fail-fast: false
      matrix:
        service:
          - api-gateway
          - auth-service
          - gps-ingestion-service
          - location-service
          - notification-service
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: 'maven'

      - name: Build shared module
        working-directory: backend
        run: mvn install -pl shared -am -DskipTests -q

      - name: Test ${{ matrix.service }}
        working-directory: backend/${{ matrix.service }}
        run: mvn test -B
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
          SPRING_DATASOURCE_USERNAME: testuser
          SPRING_DATASOURCE_PASSWORD: testpass
          SPRING_DATASOURCE_DRIVER: org.postgresql.Driver

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.service }}
          path: backend/${{ matrix.service }}/target/site/jacoco/
          retention-days: 7

  # Frontend tests
  frontend:
    name: Frontend
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci --legacy-peer-deps

      - name: Lint
        working-directory: frontend
        run: npm run lint || true

      - name: Test
        working-directory: frontend
        run: npm test -- --no-watch --no-progress --browsers=ChromeHeadless --code-coverage

      - name: Check coverage thresholds
        working-directory: frontend
        run: |
          echo "## Frontend Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract coverage from lcov report
          STATEMENTS=$(grep -m1 'Statements' coverage/frontend/index.html | grep -oP '\d+\.\d+(?=%)' || echo "0")
          LINES=$(grep -m1 'Lines' coverage/frontend/index.html | grep -oP '\d+\.\d+(?=%)' || echo "0")

          echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Statements | ${STATEMENTS}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines | ${LINES}% |" >> $GITHUB_STEP_SUMMARY

          # Check critical services coverage (guards, interceptors, core services)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Critical Services Coverage" >> $GITHUB_STEP_SUMMARY

          if [ -f "coverage/frontend/app/core/guards/index.html" ]; then
            GUARDS=$(grep -m1 'Statements' coverage/frontend/app/core/guards/index.html | grep -oP '\d+(?=%)' || echo "0")
            echo "- Guards: ${GUARDS}%" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "coverage/frontend/app/core/interceptors/index.html" ]; then
            INTERCEPTORS=$(grep -m1 'Statements' coverage/frontend/app/core/interceptors/index.html | grep -oP '\d+(?=%)' || echo "0")
            echo "- Interceptors: ${INTERCEPTORS}%" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "coverage/frontend/app/core/services/index.html" ]; then
            SERVICES=$(grep -m1 'Statements' coverage/frontend/app/core/services/index.html | grep -oP '\d+(?=%)' || echo "0")
            echo "- Core Services: ${SERVICES}%" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/
          retention-days: 7

  # Mobile tests
  mobile:
    name: Mobile
    needs: changes
    if: needs.changes.outputs.mobile == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile-expo/package-lock.json

      - name: Install dependencies
        working-directory: mobile-expo
        run: npm ci

      - name: Lint
        working-directory: mobile-expo
        run: npm run lint || true

      - name: Test
        working-directory: mobile-expo
        run: npm test -- --coverage --passWithNoTests

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-coverage
          path: mobile-expo/coverage/
          retention-days: 7

  # SonarCloud Analysis
  sonarcloud:
    name: SonarCloud Analysis
    needs: [changes, backend, frontend]
    if: |
      always() &&
      (needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true') &&
      (needs.backend.result == 'success' || needs.backend.result == 'skipped') &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for SonarCloud blame data

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: 'maven'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Download backend coverage
        if: needs.changes.outputs.backend == 'true'
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: backend/
          merge-multiple: true

      - name: Download frontend coverage
        if: needs.changes.outputs.frontend == 'true'
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/

      - name: Build backend for SonarCloud
        working-directory: backend
        run: mvn compile -DskipTests -q

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  # Summary job
  summary:
    name: Summary
    needs: [changes, backend, frontend, mobile, sonarcloud]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.changes.outputs.backend }}" == "true" ]; then
            if [ "${{ needs.backend.result }}" == "success" ]; then
              echo "| Backend | ✓ | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Backend | ✓ | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Backend | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.changes.outputs.frontend }}" == "true" ]; then
            if [ "${{ needs.frontend.result }}" == "success" ]; then
              echo "| Frontend | ✓ | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Frontend | ✓ | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Frontend | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.changes.outputs.mobile }}" == "true" ]; then
            if [ "${{ needs.mobile.result }}" == "success" ]; then
              echo "| Mobile | ✓ | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Mobile | ✓ | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Mobile | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
          fi

          # SonarCloud result
          if [ "${{ needs.changes.outputs.backend }}" == "true" ] || [ "${{ needs.changes.outputs.frontend }}" == "true" ]; then
            if [ "${{ needs.sonarcloud.result }}" == "success" ]; then
              echo "| SonarCloud | ✓ | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.sonarcloud.result }}" == "skipped" ]; then
              echo "| SonarCloud | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| SonarCloud | ✓ | ⚠️ Warning |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| SonarCloud | - | ⏭️ Skip |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any test failed
        if: |
          (needs.changes.outputs.backend == 'true' && needs.backend.result != 'success') ||
          (needs.changes.outputs.frontend == 'true' && needs.frontend.result != 'success') ||
          (needs.changes.outputs.mobile == 'true' && needs.mobile.result != 'success')
        run: exit 1
