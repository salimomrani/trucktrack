<!-- Proof of Delivery Component Template -->
<!-- Feature: 015-proof-of-delivery (T043) -->
<!-- Migrated to Tailwind CSS (Feature 020) -->

@if (loading()) {
  <div class="bg-white rounded-lg shadow-card p-8">
    <div class="flex flex-col items-center justify-center gap-3 text-gray-500">
      <div class="animate-spin rounded-full h-10 w-10 border-4 border-primary-500 border-t-transparent"></div>
      <p>Loading proof of delivery...</p>
    </div>
  </div>
}

@if (error()) {
  <div class="bg-white rounded-lg shadow-card p-8">
    <div class="flex flex-col items-center justify-center gap-3 text-danger-600">
      <span class="material-icons text-4xl">error_outline</span>
      <p>{{ error() }}</p>
      <button
        type="button"
        class="inline-flex items-center gap-2 px-4 py-2 text-primary-600 hover:bg-primary-50 rounded-md transition-colors"
        (click)="loadProof()">
        <span class="material-icons">refresh</span>
        Retry
      </button>
    </div>
  </div>
}

@if (proof(); as p) {
  <div class="bg-white rounded-lg shadow-card overflow-hidden">
    <!-- Header -->
    <div class="flex items-center gap-4 px-6 py-4 border-b border-gray-100">
      <span class="material-icons text-2xl" [style.color]="getStatusColor()">{{ getStatusIcon() }}</span>
      <div class="flex-1">
        <h3 class="text-lg font-semibold text-gray-800">Proof of Delivery</h3>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white mt-1"
          [style.background-color]="getStatusColor()">
          {{ p.statusDisplayName }}
        </span>
      </div>
    </div>

    <!-- Content -->
    <div class="p-6 space-y-6">
      <!-- Signature Section -->
      <div>
        <h4 class="text-sm font-semibold text-gray-700 mb-3">Signature</h4>
        <div
          class="relative cursor-pointer group"
          (click)="openSignatureViewer()">
          <img [src]="p.signatureImage" alt="Signature" class="max-w-full h-auto border border-gray-200 rounded-lg bg-white">
          <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-lg">
            <span class="material-icons text-white text-3xl">zoom_in</span>
            <span class="text-white ml-2">Click to enlarge</span>
          </div>
        </div>

        @if (p.signerName) {
          <p class="flex items-center gap-2 mt-2 text-sm text-gray-600">
            <span class="material-icons text-lg">person</span>
            Signed by: {{ p.signerName }}
          </p>
        }
      </div>

      <!-- Refusal Reason (if refused) -->
      @if (p.status === 'REFUSED' && p.refusalReason) {
        <div class="bg-danger-50 border border-danger-200 rounded-lg p-4">
          <h4 class="text-sm font-semibold text-danger-700 mb-2">Refusal Reason</h4>
          <p class="text-danger-600">{{ p.refusalReason }}</p>
        </div>
      }

      <!-- Photos Section -->
      @if (p.photos && p.photos.length > 0) {
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-3">Photos ({{ p.photoCount }})</h4>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
            @for (photo of p.photos; track photo.id) {
              <div class="aspect-square overflow-hidden rounded-lg border border-gray-200">
                <img [src]="photo.photoImage" alt="Proof photo" class="w-full h-full object-cover">
              </div>
            }
          </div>
        </div>
      }

      <!-- Metadata -->
      <div>
        <h4 class="text-sm font-semibold text-gray-700 mb-3">Details</h4>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="flex items-center gap-3">
            <span class="material-icons text-gray-400">access_time</span>
            <div>
              <span class="block text-xs text-gray-500">Captured</span>
              <span class="text-sm text-gray-800">{{ formatDate(p.capturedAt) }}</span>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <span class="material-icons text-gray-400">sync</span>
            <div>
              <span class="block text-xs text-gray-500">Synced</span>
              <span class="text-sm text-gray-800">{{ formatDate(p.syncedAt) }}</span>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <span class="material-icons text-gray-400">location_on</span>
            <div>
              <span class="block text-xs text-gray-500">Location</span>
              <span class="text-sm text-gray-800">{{ p.latitude.toFixed(6) }}, {{ p.longitude.toFixed(6) }}</span>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <span class="material-icons text-gray-400">gps_fixed</span>
            <div>
              <span class="block text-xs text-gray-500">GPS Accuracy</span>
              <span class="text-sm text-gray-800">{{ p.gpsAccuracy }}m</span>
            </div>
          </div>

          @if (p.createdByName) {
            <div class="flex items-center gap-3">
              <span class="material-icons text-gray-400">person</span>
              <div>
                <span class="block text-xs text-gray-500">Created by</span>
                <span class="text-sm text-gray-800">{{ p.createdByName }}</span>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Integrity Hash -->
      <div class="flex items-center gap-2 text-sm text-gray-500 bg-gray-50 px-4 py-2 rounded-lg">
        <span class="material-icons text-lg">verified</span>
        <span>Integrity Hash:</span>
        <code class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">{{ p.integrityHash.substring(0, 16) }}...</code>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-end px-6 py-4 border-t border-gray-100">
      <button
        type="button"
        class="inline-flex items-center gap-2 px-4 py-2 text-primary-600 hover:bg-primary-50 rounded-md transition-colors disabled:opacity-50"
        (click)="downloadPdf()"
        [disabled]="downloadingPdf()">
        @if (downloadingPdf()) {
          <div class="animate-spin rounded-full h-5 w-5 border-2 border-primary-500 border-t-transparent"></div>
        } @else {
          <span class="material-icons">download</span>
        }
        Download PDF
      </button>
    </div>
  </div>
}

@if (!hasProof() && !loading()) {
  <div class="bg-white rounded-lg shadow-card p-8">
    <div class="flex flex-col items-center justify-center gap-3 text-gray-400">
      <span class="material-icons text-4xl">edit_off</span>
      <p class="text-gray-600">No proof of delivery yet</p>
      <span class="text-sm">Proof will be available when the driver completes the delivery</span>
    </div>
  </div>
}
