<div class="data-table-container">
  <!-- Search bar -->
  @if (searchable()) {
    <div class="table-header">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search</mat-label>
        <input matInput
               [placeholder]="searchPlaceholder()"
               [(ngModel)]="searchValue"
               (input)="onSearch($event)"
               aria-label="Search table">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
  }

  <!-- Loading spinner -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  }

  <!-- Table -->
  <div class="table-wrapper" [class.loading]="isLoading()">
    <table mat-table [dataSource]="dataSource" matSort (matSortChange)="onSort($event)">

      <!-- Selection column -->
      @if (selectable()) {
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox (change)="$event ? toggleAllRows() : null"
                          [checked]="selection.hasValue() && isAllSelected()"
                          [indeterminate]="selection.hasValue() && !isAllSelected()"
                          aria-label="Select all rows">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox (click)="$event.stopPropagation()"
                          (change)="$event ? selection.toggle(row) : null"
                          [checked]="selection.isSelected(row)"
                          [aria-label]="'Select row'">
            </mat-checkbox>
          </td>
        </ng-container>
      }

      <!-- Dynamic columns -->
      @for (col of columns(); track col.key) {
        <ng-container [matColumnDef]="col.key">
          <th mat-header-cell *matHeaderCellDef
              [mat-sort-header]="col.sortable ? col.key : ''"
              [disabled]="!col.sortable"
              [style.width]="col.width">
            {{ col.header }}
          </th>
          <td mat-cell *matCellDef="let row" [style.width]="col.width">
            @switch (col.type) {
              @case ('date') {
                {{ row[col.key] | date:'short' }}
              }
              @case ('badge') {
                <span class="badge" [style.background-color]="getBadgeColor(col, row[col.key])">
                  {{ row[col.key] }}
                </span>
              }
              @case ('boolean') {
                <mat-icon [class.active]="row[col.key]">
                  {{ row[col.key] ? 'check_circle' : 'cancel' }}
                </mat-icon>
              }
              @case ('actions') {
                <ng-content select="[actions]"></ng-content>
              }
              @default {
                {{ row[col.key] }}
              }
            }
          </td>
        </ng-container>
      }

      <!-- Actions column -->
      @if (showActions()) {
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef style="width: 120px">Actions</th>
          <td mat-cell *matCellDef="let row">
            <button mat-icon-button
                    matTooltip="Edit"
                    (click)="onEdit.emit(row)"
                    aria-label="Edit row">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button
                    matTooltip="Delete"
                    (click)="onDelete.emit(row)"
                    aria-label="Delete row">
              <mat-icon color="warn">delete</mat-icon>
            </button>
          </td>
        </ng-container>
      }

      <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns();"
          (click)="onRowClick.emit(row)"
          [class.clickable]="rowClickable()">
      </tr>

      <!-- No data row -->
      <tr class="mat-row no-data" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns().length">
          <div class="no-data-message">
            <mat-icon>inbox</mat-icon>
            <span>{{ noDataMessage() }}</span>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <!-- Paginator -->
  <mat-paginator [length]="totalElements()"
                 [pageSize]="pageSize()"
                 [pageSizeOptions]="pageSizeOptions()"
                 [pageIndex]="pageIndex()"
                 (page)="onPageChange($event)"
                 showFirstLastButtons
                 aria-label="Select page">
  </mat-paginator>
</div>
