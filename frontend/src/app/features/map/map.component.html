<!-- Map Container - Full height map with floating controls -->
<div class="map-container relative w-full overflow-hidden" style="height: calc(100vh - 64px);">
  <!-- Map container (takes full space) -->
  <div id="map" class="absolute inset-0"></div>

  <!-- Floating toolbar - top right -->
  <div class="absolute top-4 right-4 z-[1001] flex items-center gap-3">
    <!-- Search Bar -->
    <app-search-bar />

    <!-- Status pill -->
    <div class="flex items-center gap-3 px-4 py-2 bg-white rounded-full shadow-md border border-gray-200">
      <!-- Loading indicator (T091) -->
      @if (isLoading()) {
        <div class="flex items-center gap-2 text-sm text-gray-500">
          <div class="animate-spin rounded-full h-4 w-4 border-2 border-primary-500 border-t-transparent"></div>
        </div>
      }

      <!-- WebSocket connection status (T090) -->
      <div class="flex items-center gap-2 text-sm text-gray-600">
        <span
          class="w-2 h-2 rounded-full"
          [class.bg-warning-500]="!isConnected()"
          [class.bg-success-500]="isConnected()"
          [class.animate-pulse]="!isConnected()"></span>
        <span class="hidden sm:inline">{{ isConnected() ? 'Live' : '...' }}</span>
      </div>

      <!-- Divider -->
      <div class="w-px h-4 bg-gray-300"></div>

      <!-- Truck count - T108: Show filtered count when filters active -->
      <div class="flex items-center gap-1.5 text-sm font-medium">
        <span class="material-icons text-base text-gray-500">local_shipping</span>
        @if (hasActiveFilters()) {
          <span class="text-primary-600">{{ filteredTrucks().length }}/{{ trucks().length }}</span>
        } @else {
          <span class="text-gray-700">{{ trucks().length }}</span>
        }
      </div>
    </div>
  </div>

  <!-- Error message (T092) - floating alert -->
  @if (errorMessage()) {
    <div class="absolute top-4 left-1/2 -translate-x-1/2 z-[1002] flex items-center gap-2 px-4 py-2 bg-danger-50 text-danger-700 rounded-lg shadow-md border border-danger-200">
      <span class="material-icons text-lg">error</span>
      <span class="text-sm">{{ errorMessage() }}</span>
    </div>
  }

  <!-- T104: Filter Panel - positioned on map (below zoom controls) -->
  <div class="absolute top-24 left-4 z-[1001]">
    <app-filter-panel />
  </div>

  <!-- T126: History controls panel -->
  @if (historyMode()) {
    <div class="absolute bottom-6 left-1/2 -translate-x-1/2 z-[1000] bg-white px-5 py-3 rounded-lg shadow-lg flex items-center gap-4">
      <div class="flex items-center gap-2 font-medium text-primary-600">
        <span class="material-icons">route</span>
        <span>Truck History (24h)</span>
      </div>
      <button
        type="button"
        class="inline-flex items-center gap-2 px-4 py-2 bg-danger-600 text-white rounded-md hover:bg-danger-700 transition-colors"
        (click)="clearHistory()">
        <span class="material-icons text-lg">close</span>
        Clear History
      </button>
    </div>
  }

  <!-- History loading indicator -->
  @if (historyLoading()) {
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[1001] bg-white/95 px-8 py-5 rounded-lg shadow-lg flex items-center gap-3">
      <div class="animate-spin rounded-full h-8 w-8 border-4 border-primary-500 border-t-transparent"></div>
      <span class="text-gray-600">Loading history...</span>
    </div>
  }

  <!-- T154: Geofence Panel -->
  @if (map) {
    <app-geofence-panel [map]="map" />
  }
</div>
